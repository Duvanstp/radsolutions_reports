name: Django Tests and Linting

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies in GitHub Actions runner
      run: |
        python -m pip install --upgrade pip
        pip install isort flake8 black pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Create .env file
      run: |
        echo "DATABASE_NAME=radsolutions_db" >> .env
        echo "DATABASE_USER=radsolutions_user" >> .env
        echo "DATABASE_PASSWORD=radsolutions_pass" >> .env
        echo "DATABASE_HOST=db" >> .env
        echo "DATABASE_PORT=5432" >> .env
        echo "DEBUG=True" >> .env
        echo "DJANGO_SECRET_KEY='django-insecure-k#cb*25^f8d9js*%rnkjc24_^r^(8#-@$m*8ia1-zn*ytg=#u*'" >> .env
    
    - name: Build Docker containers
      run: |
        docker compose build web
        docker compose up -d db
    
    - name: Run Django tests
      run: |
        docker compose run --rm web bash -c "python manage.py test"
    
    - name: Run linting checks
      run: |
        docker compose run --rm web bash -c "pip install isort flake8 black && isort . --check && black . --check && flake8 ."
    
    - name: Stop containers
      run: |
        docker compose down 